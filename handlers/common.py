# epicservice/handlers/common.py

import logging

from aiogram import F, Router
from aiogram.filters import Command, CommandStart
from aiogram.fsm.context import FSMContext
from aiogram.types import Message

from config import ADMIN_IDS
from database.engine import async_session
from database.models import User
from keyboards.reply import get_main_menu_kb

logger = logging.getLogger(__name__)
router = Router()


# ==============================================================================
# üöÄ –ö–û–ú–ê–ù–î–ê /START
# ==============================================================================


@router.message(CommandStart())
async def cmd_start(message: Message, state: FSMContext):
    """–û–±—Ä–æ–±–ª—è—î –∫–æ–º–∞–Ω–¥—É /start - —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —Ç–∞ –≤—ñ—Ç–∞–Ω–Ω—è."""
    user_id = message.from_user.id
    username = message.from_user.username
    first_name = message.from_user.first_name or "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á"

    # –û—á–∏—â–∞—î–º–æ —Å—Ç–∞–Ω –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
    await state.clear()

    try:
        # –†–µ—î—Å—Ç—Ä—É—î–º–æ –∞–±–æ –æ–Ω–æ–≤–ª—é—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤ –ë–î
        async with async_session() as session:
            result = await session.get(User, user_id)

            if result:
                # –û–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ —ñ—Å–Ω—É—é—á–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
                result.username = username
                result.first_name = first_name
                logger.info("–û–Ω–æ–≤–ª–µ–Ω–æ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: %s (@%s)", user_id, username)
            else:
                # –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
                new_user = User(
                    id=user_id,
                    username=username,
                    first_name=first_name,
                )
                session.add(new_user)
                logger.info(
                    "–ó–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ –Ω–æ–≤–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: %s (@%s)", user_id, username
                )

            await session.commit()

    except Exception as e:
        logger.error("–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ %s: %s", user_id, e, exc_info=True)

    # –í—ñ—Ç–∞–ª—å–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    is_admin = user_id in ADMIN_IDS

    welcome_text = (
        f"üëã **–í—ñ—Ç–∞—î–º–æ, {first_name}!**\n\n"
        f"–¶–µ –±–æ—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Å–∫–ª–∞–¥—Å—å–∫–∏–º–∏ –∑–∞–ª–∏—à–∫–∞–º–∏.\n\n"
        f"**–©–æ —è –≤–º—ñ—é:**\n"
        f"‚Ä¢ üîç –ü–æ—à—É–∫ —Ç–æ–≤–∞—Ä—ñ–≤ –∑–∞ –Ω–∞–∑–≤–æ—é –∞–±–æ –∞—Ä—Ç–∏–∫—É–ª–æ–º\n"
        f"‚Ä¢ üì¶ –§–æ—Ä–º—É–≤–∞–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω—å\n"
        f"‚Ä¢ üíæ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó —Å–ø–∏—Å–∫—ñ–≤\n"
        f"‚Ä¢ üóÇ –†–æ–±–æ—Ç–∞ –∑ –∞—Ä—Ö—ñ–≤–∞–º–∏\n\n"
    )

    if is_admin:
        welcome_text += (
            f"üëë **–í–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä!**\n"
            f"–î–æ—Å—Ç—É–ø–Ω—ñ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ—É–Ω–∫—Ü—ñ—ó:\n"
            f"‚Ä¢ –Ü–º–ø–æ—Ä—Ç/–µ–∫—Å–ø–æ—Ä—Ç –∑–∞–ª–∏—à–∫—ñ–≤\n"
            f"‚Ä¢ –ü–µ—Ä–µ–≥–ª—è–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏\n"
            f"‚Ä¢ –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏\n\n"
        )

    welcome_text += (
        f"–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –º–µ–Ω—é –Ω–∏–∂—á–µ –¥–ª—è –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó.\n"
        f"–î–ª—è –ø–æ—à—É–∫—É —Ç–æ–≤–∞—Ä—É - –ø—Ä–æ—Å—Ç–æ –Ω–∞–¥—ñ—à–ª—ñ—Ç—å –Ω–∞–∑–≤—É –∞–±–æ –∞—Ä—Ç–∏–∫—É–ª."
    )

    await message.answer(welcome_text, reply_markup=get_main_menu_kb(is_admin))


# ==============================================================================
# ‚ùì –ö–û–ú–ê–ù–î–ê /HELP
# ==============================================================================


@router.message(Command("help"))
async def cmd_help(message: Message):
    """–û–±—Ä–æ–±–ª—è—î –∫–æ–º–∞–Ω–¥—É /help - –¥–æ–≤—ñ–¥–∫–∞."""
    user_id = message.from_user.id
    is_admin = user_id in ADMIN_IDS

    help_text = (
        "üìñ **–î–æ–≤—ñ–¥–∫–∞ –ø–æ —Ä–æ–±–æ—Ç—ñ –∑ –±–æ—Ç–æ–º**\n\n"
        "**üîç –ü–æ—à—É–∫ —Ç–æ–≤–∞—Ä—ñ–≤:**\n"
        "–ü—Ä–æ—Å—Ç–æ –Ω–∞–¥—ñ—à–ª—ñ—Ç—å –Ω–∞–∑–≤—É –∞–±–æ –∞—Ä—Ç–∏–∫—É–ª —Ç–æ–≤–∞—Ä—É.\n"
        "–ë–æ—Ç –∑–Ω–∞–π–¥–µ –≤—Å—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ –ø–æ–∑–∏—Ü—ñ—ó.\n\n"
        "**üì¶ –†–æ–±–æ—Ç–∞ –∑—ñ —Å–ø–∏—Å–∫–æ–º:**\n"
        "‚Ä¢ **–ú—ñ–π —Å–ø–∏—Å–æ–∫** - –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –ø–æ—Ç–æ—á–Ω—ñ —Ç–æ–≤–∞—Ä–∏\n"
        "‚Ä¢ **–†–µ–¥–∞–≥—É–≤–∞—Ç–∏** - –∑–º—ñ–Ω–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–∑–∏—Ü—ñ–π\n"
        "‚Ä¢ **–ó–±–µ—Ä–µ–≥—Ç–∏** - —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è\n"
        "‚Ä¢ **–í–∏–¥–∞–ª–∏—Ç–∏** - –æ—á–∏—Å—Ç–∏—Ç–∏ —Å–ø–∏—Å–æ–∫\n\n"
        "**üóÇ –ê—Ä—Ö—ñ–≤–∏:**\n"
        "‚Ä¢ **–ú–æ—ó –∞—Ä—Ö—ñ–≤–∏** - –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è\n"
        "‚Ä¢ **–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—Å–µ** - –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤—Å—é —ñ—Å—Ç–æ—Ä—ñ—é –æ–¥–Ω–∏–º –∞—Ä—Ö—ñ–≤–æ–º\n\n"
        "**‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Å–ø–∏—Å–∫—É:**\n"
        "–ü—ñ–¥ —á–∞—Å —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –º–æ–∂–Ω–∞:\n"
        "‚Ä¢ –í–≤–µ—Å—Ç–∏ `3` - –≤–∏–±—Ä–∞—Ç–∏ –ø–æ–∑–∏—Ü—ñ—é ‚Ññ3\n"
        "‚Ä¢ –í–≤–µ—Å—Ç–∏ `3 15` - –∑–º—ñ–Ω–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–∑–∏—Ü—ñ—ó ‚Ññ3 –Ω–∞ 15\n"
        "‚Ä¢ –í–≤–µ—Å—Ç–∏ `3 0` - –≤–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–∑–∏—Ü—ñ—é ‚Ññ3\n\n"
    )

    if is_admin:
        help_text += (
            "**üëë –ê–¥–º—ñ–Ω-—Ñ—É–Ω–∫—Ü—ñ—ó:**\n"
            "‚Ä¢ **–Ü–º–ø–æ—Ä—Ç** - –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–ª–∏—à–∫—ñ–≤ –∑ Excel\n"
            "‚Ä¢ **–ï–∫—Å–ø–æ—Ä—Ç –∑–∞–ª–∏—à–∫—ñ–≤** - –≤–∏–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–∏—Ö –∑–∞–ª–∏—à–∫—ñ–≤\n"
            "‚Ä¢ **–ï–∫—Å–ø–æ—Ä—Ç –∑—ñ–±—Ä–∞–Ω–æ–≥–æ** - –∑–≤—ñ—Ç –ø–æ –≤—Å—ñ—Ö –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è—Ö\n"
            "‚Ä¢ **–Ü–º–ø–æ—Ä—Ç –∑—ñ–±—Ä–∞–Ω–æ–≥–æ** - –≤—ñ–¥–Ω—ñ–º–∞–Ω–Ω—è –∑—ñ–±—Ä–∞–Ω–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤\n"
            "‚Ä¢ **–£—Ç–∏–ª—ñ—Ç–∏** - –¥–æ–¥–∞—Ç–∫–æ–≤—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏\n\n"
        )

    help_text += (
        "**üí° –ü–æ—Ä–∞–¥–∏:**\n"
        "‚Ä¢ –°–ø–∏—Å–æ–∫ –º–æ–∂–µ –º—ñ—Å—Ç–∏—Ç–∏ —Ç–æ–≤–∞—Ä–∏ –ª–∏—à–µ –∑ –æ–¥–Ω–æ–≥–æ –≤—ñ–¥–¥—ñ–ª—É\n"
        "‚Ä¢ –î–ª—è –Ω–æ–≤–æ–≥–æ –≤—ñ–¥–¥—ñ–ª—É —Å—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π —Å–ø–∏—Å–æ–∫\n"
        "‚Ä¢ –†–µ–∑–µ—Ä–≤—É–≤–∞–Ω–Ω—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–Ω—ñ–º–∞—î—Ç—å—Å—è –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ\n\n"
        "–ü–∏—Ç–∞–Ω–Ω—è? –ù–∞–ø–∏—à—ñ—Ç—å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—É."
    )

    await message.answer(help_text)


# ==============================================================================
# üîß –ö–û–ú–ê–ù–î–ê /RESET (–°–ö–ò–î–ê–ù–ù–Ø –°–¢–ê–ù–£)
# ==============================================================================


@router.message(Command("reset"))
async def cmd_reset(message: Message, state: FSMContext):
    """–°–∫–∏–¥–∞—î —Å—Ç–∞–Ω FSM –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞."""
    await state.clear()
    user_id = message.from_user.id
    is_admin = user_id in ADMIN_IDS

    await message.answer(
        "üîÑ –°—Ç–∞–Ω —Å–∫–∏–Ω—É—Ç–æ. –í–∏ –ø–æ–≤–µ—Ä–Ω—É–ª–∏—Å—å –¥–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é.",
        reply_markup=get_main_menu_kb(is_admin),
    )


# ==============================================================================
# üìä –ö–û–ú–ê–ù–î–ê /STATS (–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ö–û–†–ò–°–¢–£–í–ê–ß–ê)
# ==============================================================================


@router.message(Command("stats"))
async def cmd_stats(message: Message):
    """–ü–æ–∫–∞–∑—É—î —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞."""
    user_id = message.from_user.id

    try:
        from database.orm import orm_get_temp_list, orm_get_user_lists_archive

        # –ü–æ—Ç–æ—á–Ω–∏–π —Å–ø–∏—Å–æ–∫
        temp_list = await orm_get_temp_list(user_id)
        current_items = len(temp_list)
        current_qty = sum(item.quantity for item in temp_list)

        # –ê—Ä—Ö—ñ–≤–∏
        archives = await orm_get_user_lists_archive(user_id)
        archives_count = len(archives)

        stats_text = (
            f"üìä **–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**\n\n"
            f"**–ü–æ—Ç–æ—á–Ω–∏–π —Å–ø–∏—Å–æ–∫:**\n"
            f"‚Ä¢ –ü–æ–∑–∏—Ü—ñ–π: {current_items}\n"
            f"‚Ä¢ –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å: {current_qty}\n\n"
            f"**–ê—Ä—Ö—ñ–≤–∏:**\n"
            f"‚Ä¢ –ó–±–µ—Ä–µ–∂–µ–Ω–æ —Å–ø–∏—Å–∫—ñ–≤: {archives_count}\n"
        )

        if archives_count > 0:
            last_date = archives[0].created_at.strftime("%d.%m.%Y %H:%M")
            stats_text += f"‚Ä¢ –û—Å—Ç–∞–Ω–Ω—ñ–π: {last_date}\n"

        await message.answer(stats_text)

    except Exception as e:
        logger.error(
            "–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è %s: %s", user_id, e, exc_info=True
        )
        await message.answer("‚ùå –ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.")


# ==============================================================================
# ‚ÑπÔ∏è –ö–û–ú–ê–ù–î–ê /ABOUT (–ü–†–û –ë–û–¢–ê)
# ==============================================================================


@router.message(Command("about"))
async def cmd_about(message: Message):
    """–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –±–æ—Ç–∞."""
    about_text = (
        "‚ÑπÔ∏è **EpicService Bot**\n\n"
        "**–í–µ—Ä—Å—ñ—è:** 2.0\n"
        "**–î–∞—Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:** 28.11.2025\n\n"
        "**–û—Å–Ω–æ–≤–Ω—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ:**\n"
        "‚úÖ –ü–æ—à—É–∫ —Ç–æ–≤–∞—Ä—ñ–≤\n"
        "‚úÖ –§–æ—Ä–º—É–≤–∞–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω—å\n"
        "‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∑–∞–ª–∏—à–∫—ñ–≤\n"
        "‚úÖ –Ü—Å—Ç–æ—Ä—ñ—è –∑–∞–º–æ–≤–ª–µ–Ω—å\n"
        "‚úÖ –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å\n\n"
        "**–¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó:**\n"
        "‚Ä¢ Python 3.11+\n"
        "‚Ä¢ aiogram 3.x\n"
        "‚Ä¢ SQLAlchemy 2.0\n"
        "‚Ä¢ PostgreSQL / SQLite\n\n"
        "–†–æ–∑—Ä–æ–±–Ω–∏–∫: @your_username"
    )

    await message.answer(about_text)
