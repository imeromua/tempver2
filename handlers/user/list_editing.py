# epicservice/handlers/user/list_editing.py

import logging

from aiogram import Bot, F, Router
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.types import Message

from config import ADMIN_IDS
from database.engine import async_session
from database.orm import (
    orm_delete_item_from_temp_list,
    orm_get_temp_list,
    orm_update_item_quantity,
)
from keyboards.reply import get_list_editing_kb, get_main_menu_kb

logger = logging.getLogger(__name__)
router = Router()


class ListEditingStates(StatesGroup):
    editing_list = State()
    waiting_for_item_number = State()
    waiting_for_new_quantity = State()


# ==============================================================================
# üìã –ü–û–ö–ê–ó –°–ü–ò–°–ö–£ –í –†–ï–ñ–ò–ú–Ü –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø
# ==============================================================================


async def show_list_in_edit_mode(
    bot: Bot, chat_id: int, user_id: int, state: FSMContext
):
    """–ü–æ–∫–∞–∑—É—î —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä—ñ–≤ –∑ –Ω—É–º–µ—Ä–∞—Ü—ñ—î—é –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è."""
    temp_list = await orm_get_temp_list(user_id)

    if not temp_list:
        is_admin = user_id in ADMIN_IDS
        await bot.send_message(
            chat_id,
            "üì≠ –í–∞—à —Å–ø–∏—Å–æ–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π.",
            reply_markup=get_main_menu_kb(is_admin),
        )
        await state.clear()
        return

    dept = temp_list[0].product.–≤—ñ–¥–¥—ñ–ª
    text_lines = [f"‚úèÔ∏è **–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Å–ø–∏—Å–∫—É (–í—ñ–¥–¥—ñ–ª: {dept})**\n"]

    for idx, item in enumerate(temp_list, start=1):
        text_lines.append(
            f"{idx}. `{item.product.–∞—Ä—Ç–∏–∫—É–ª}` {item.product.–Ω–∞–∑–≤–∞}\n"
            f"   –ö—ñ–ª—å–∫—ñ—Å—Ç—å: **{item.quantity}** —à—Ç.\n"
        )

    text_lines.append(
        "\nüìù **–ö–æ–º–∞–Ω–¥–∏:**\n"
        "‚Ä¢ `N` - –≤–∏–±—Ä–∞—Ç–∏ –ø–æ–∑–∏—Ü—ñ—é ‚ÑñN (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: `3`)\n"
        "‚Ä¢ `N 0` - –≤–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–∑–∏—Ü—ñ—é ‚ÑñN (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: `3 0`)\n"
        "‚Ä¢ `N K` - –∑–º—ñ–Ω–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–∑–∏—Ü—ñ—ó ‚ÑñN –Ω–∞ K (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: `3 15`)\n"
        "‚Ä¢ –ê–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂—á–µ"
    )

    full_text = "\n".join(text_lines)
    if len(full_text) > 4000:
        full_text = full_text[:3900] + "\n... (—Å–ø–∏—Å–æ–∫ –∑–∞–Ω–∞–¥—Ç–æ –¥–æ–≤–≥–∏–π)"

    await bot.send_message(chat_id, full_text, reply_markup=get_list_editing_kb())
    await state.set_state(ListEditingStates.editing_list)


# ==============================================================================
# ‚úÖ –ó–ê–í–ï–†–®–ï–ù–ù–Ø –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø
# ==============================================================================


@router.message(ListEditingStates.editing_list, F.text == "‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è")
async def finish_editing(message: Message, state: FSMContext):
    """–ó–∞–≤–µ—Ä—à—É—î —Ä–µ–∂–∏–º —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è."""
    await state.clear()
    user_id = message.from_user.id
    is_admin = user_id in ADMIN_IDS

    await message.answer(
        "‚úÖ –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ.", reply_markup=get_main_menu_kb(is_admin)
    )


# ==============================================================================
# üìù –û–ë–†–û–ë–ö–ê –ö–û–ú–ê–ù–î –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø
# ==============================================================================


@router.message(ListEditingStates.editing_list, F.text.regexp(r"^\d+$"))
async def select_item_by_number(message: Message, state: FSMContext, bot: Bot):
    """–û–±—Ä–æ–±–ª—è—î –≤–∏–±—ñ—Ä –ø–æ–∑–∏—Ü—ñ—ó –∑–∞ –Ω–æ–º–µ—Ä–æ–º (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: '3')."""
    user_id = message.from_user.id
    temp_list = await orm_get_temp_list(user_id)

    try:
        item_number = int(message.text)
        if item_number < 1 or item_number > len(temp_list):
            await message.answer(
                f"‚ùå –ù–µ–≤—ñ—Ä–Ω–∏–π –Ω–æ–º–µ—Ä. –û–±–µ—Ä—ñ—Ç—å –≤—ñ–¥ 1 –¥–æ {len(temp_list)}."
            )
            return

        selected_item = temp_list[item_number - 1]
        await state.update_data(selected_item_id=selected_item.id)
        await state.set_state(ListEditingStates.waiting_for_new_quantity)

        await message.answer(
            f"üì¶ –û–±—Ä–∞–Ω–æ: **{selected_item.product.–Ω–∞–∑–≤–∞}**\n"
            f"–ü–æ—Ç–æ—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å: **{selected_item.quantity}** —à—Ç.\n\n"
            f"–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å (–∞–±–æ `0` –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è):"
        )

    except ValueError:
        await message.answer("‚ùå –ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç. –í–≤–µ–¥—ñ—Ç—å —á–∏—Å–ª–æ.")


@router.message(ListEditingStates.editing_list, F.text.regexp(r"^\d+\s+\d+$"))
async def quick_edit_item(message: Message, state: FSMContext, bot: Bot):
    """–û–±—Ä–æ–±–ª—è—î —à–≤–∏–¥–∫–µ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: '3 15' –∞–±–æ '3 0')."""
    user_id = message.from_user.id
    temp_list = await orm_get_temp_list(user_id)

    try:
        parts = message.text.split()
        item_number = int(parts[0])
        new_quantity = int(parts[1])

        if item_number < 1 or item_number > len(temp_list):
            await message.answer(
                f"‚ùå –ù–µ–≤—ñ—Ä–Ω–∏–π –Ω–æ–º–µ—Ä. –û–±–µ—Ä—ñ—Ç—å –≤—ñ–¥ 1 –¥–æ {len(temp_list)}."
            )
            return

        selected_item = temp_list[item_number - 1]

        if new_quantity == 0:
            # –í–∏–¥–∞–ª–µ–Ω–Ω—è
            await orm_delete_item_from_temp_list(selected_item.id)
            await message.answer(f"üóë –ü–æ–∑–∏—Ü—ñ—é #{item_number} –≤–∏–¥–∞–ª–µ–Ω–æ.")
        elif new_quantity > 0:
            # –ó–º—ñ–Ω–∞ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ
            async with async_session() as session:
                await orm_update_item_quantity(session, selected_item.id, new_quantity)
            await message.answer(
                f"‚úÖ –ü–æ–∑–∏—Ü—ñ—é #{item_number} –æ–Ω–æ–≤–ª–µ–Ω–æ: **{new_quantity}** —à—Ç."
            )
        else:
            await message.answer("‚ùå –ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ >= 0.")
            return

        # –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫
        await show_list_in_edit_mode(bot, message.chat.id, user_id, state)

    except (ValueError, IndexError):
        await message.answer("‚ùå –ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ: `N K` (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: `3 15`)")


# ==============================================================================
# üî¢ –û–ë–†–û–ë–ö–ê –ù–û–í–û–á –ö–Ü–õ–¨–ö–û–°–¢–Ü
# ==============================================================================


@router.message(ListEditingStates.waiting_for_new_quantity, F.text.regexp(r"^\d+$"))
async def process_new_quantity(message: Message, state: FSMContext, bot: Bot):
    """–û–±—Ä–æ–±–ª—è—î –≤–≤–µ–¥–µ–Ω—É –Ω–æ–≤—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å."""
    user_id = message.from_user.id
    data = await state.get_data()
    item_id = data.get("selected_item_id")

    try:
        new_quantity = int(message.text)

        if new_quantity == 0:
            # –í–∏–¥–∞–ª–µ–Ω–Ω—è
            await orm_delete_item_from_temp_list(item_id)
            await message.answer("üóë –ü–æ–∑–∏—Ü—ñ—é –≤–∏–¥–∞–ª–µ–Ω–æ.")
        elif new_quantity > 0:
            # –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ
            async with async_session() as session:
                await orm_update_item_quantity(session, item_id, new_quantity)
            await message.answer(f"‚úÖ –ö—ñ–ª—å–∫—ñ—Å—Ç—å –æ–Ω–æ–≤–ª–µ–Ω–æ: **{new_quantity}** —à—Ç.")
        else:
            await message.answer("‚ùå –ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ >= 0.")
            return

        # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—å –¥–æ —Å–ø–∏—Å–∫—É
        await state.set_state(ListEditingStates.editing_list)
        await show_list_in_edit_mode(bot, message.chat.id, user_id, state)

    except ValueError:
        await message.answer("‚ùå –ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç. –í–≤–µ–¥—ñ—Ç—å —á–∏—Å–ª–æ.")


@router.message(ListEditingStates.waiting_for_new_quantity)
async def invalid_quantity_input(message: Message):
    """–û–±—Ä–æ–±–ª—è—î –Ω–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –≤–≤–µ–¥–µ–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ."""
    await message.answer("‚ùå –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —á–∏—Å–ª–æ (–∞–±–æ `0` –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è).")


# ==============================================================================
# ‚ùå –û–ë–†–û–ë–ö–ê –ù–ï–í–Ü–î–û–ú–ò–• –ö–û–ú–ê–ù–î –í –†–ï–ñ–ò–ú–Ü –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø
# ==============================================================================


@router.message(ListEditingStates.editing_list)
async def unknown_editing_command(message: Message):
    """–û–±—Ä–æ–±–ª—è—î –Ω–µ–≤—ñ–¥–æ–º—ñ –∫–æ–º–∞–Ω–¥–∏ –≤ —Ä–µ–∂–∏–º—ñ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è."""
    await message.answer(
        "‚ùå –ù–µ–≤—ñ–¥–æ–º–∞ –∫–æ–º–∞–Ω–¥–∞.\n\n"
        "**–î–æ—Å—Ç—É–ø–Ω—ñ —Ñ–æ—Ä–º–∞—Ç–∏:**\n"
        "‚Ä¢ `N` - –≤–∏–±—Ä–∞—Ç–∏ –ø–æ–∑–∏—Ü—ñ—é\n"
        "‚Ä¢ `N K` - –∑–º—ñ–Ω–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å\n"
        "‚Ä¢ `N 0` - –≤–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–∑–∏—Ü—ñ—é\n\n"
        "–ê–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ –∫–Ω–æ–ø–∫—É '‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è'"
    )
# ==============================================================================